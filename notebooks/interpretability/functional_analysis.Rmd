---
title: "Functional Analysis Notebook"
author: "Rayane Adam"
output:
  html_notebook:
    theme: flatly
    highlight: tango
    toc: true
    toc_depth: 3
    number_sections: true
    code_folding: hide
---

## Environment prep

This notebook was made to perform pathway analysis using the GSEA method, it will be performed using the `clusterProfiler` package in R.

```{r install_depencies}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
if (!requireNamespace("umap", quietly = TRUE))
    install.packages("umap")
if (!requireNamespace("clusterProfiler", quietly = TRUE) || !requireNamespace("org.Hs.eg.db", quietly = TRUE)||
    !requireNamespace("enrichplot", quietly = TRUE))
    BiocManager::install(c("clusterProfiler",'org.Hs.eg.db','enrichplot'))
```

```{r}
library(clusterProfiler)
library(org.Hs.eg.db)
library(enrichplot)
library(ggplot2)
library(umap)
```

## data Preparation

Need to have here ranked gene list to proceed with GSEA analysis, will be performed on KEGG pathways.  
Note though that this gene list will be coming from a "loadings" vector, as in the contribution of genes in a single embedding vector (gene program), where it will be ranked based on its number.

As scikit-learn silently casts complex values into the real space, the same will be done here by taking the modulus of the complex numbers (i.e., $\sqrt{(real^2 + imag^2)}$) (might consider performing another approach).

```{r}
library(reticulate)
py_require(c("scikit-learn","pandas"))
py_require(c("GEOparse"))
```


```{python}
import os,sys
py_install('pandas')
sys.path.append('../../src/ml')
from load_matrix import load_protein_embeddings, _load_raw_protein_embeddings

model='Complex'
version='v2.11'

df_raw=_load_raw_protein_embeddings(model,version)
df_raw.index=df_raw.iloc[:,-1] #-- gene symbol as index
df_raw.iloc[:,5:] # -- showing the embeddings columns
```

```{r}
df_raw = py$df_raw
df_raw = as.data.frame(df_raw)

# head(df_raw)
```

```{r}
# df=read.csv("../../results/temp_datasets/weighted_RGCN_protein_embeddings_v2.11_minmax.csv")
```


### Embedding 

```{r}
embedding_num=128

col=paste0('emb_',embedding_num)
# -- soring based on col
df_sorted <- df_raw[order(df_raw[[col]], decreasing = TRUE), ]

# -- fa
gene_list <- df_sorted[[col]]
names(gene_list) <- rownames(df_sorted)
head(gene_list)
```

```{r}
# -- umap
library(umap)
set.seed(42)

numeric_data <- df_raw[, sapply(df_raw, is.numeric)]
embedding <- umap(as.matrix(t(numeric_data)))

plot(embedding$layout, main="UMAP of Protein Embeddings", xlab="UMAP1", ylab="UMAP2")
```


### enrichR

```{r}
gene_df <- bitr(
  names(gene_list),
  fromType = "SYMBOL",
  toType   = "ENTREZID",
  OrgDb    = org.Hs.eg.db
)

gene_list_entrez <- gene_list[gene_df$SYMBOL]
names(gene_list_entrez) <- gene_df$ENTREZID

gene_list_entrez <- sort(gene_list_entrez, decreasing = TRUE)


gsea_kegg <- gseKEGG(
  geneList     = gene_list_entrez,
  organism     = "hsa",
  pvalueCutoff = 0.05
)
gsea_kegg
```

```{r}
dotplot(gsea_kegg, showCategory=20, title=paste0("GSEA KEGG pathways - Embedding ",embedding_num))
```



### automating

```{r}

model_version <- paste(py$model, py$version, sep = "_")
base_results_dir <- file.path("../../results/pathway_analysis", model_version)

if (!dir.exists(base_results_dir)) {
  dir.create(base_results_dir, recursive = TRUE)
}

# identify embedding columns
embedding_cols <- grep("^emb_", colnames(df_raw), value = TRUE)
length(embedding_cols)

library(clusterProfiler)
library(enrichplot)
library(org.Hs.eg.db)
library(ggplot2)

for (col in embedding_cols) {

  message("Processing ", col)

  embedding_num <- gsub("emb_", "", col)

  ## ---- rank genes
  df_sorted <- df_raw[order(df_raw[[col]], decreasing = TRUE), ]
  gene_list <- df_sorted[[col]]
  names(gene_list) <- rownames(df_sorted)

  ## ---- SYMBOL → ENTREZ
  gene_df <- bitr(
    names(gene_list),
    fromType = "SYMBOL",
    toType   = "ENTREZID",
    OrgDb    = org.Hs.eg.db
  )

  if (nrow(gene_df) < 10) {
    warning("Skipping ", col, " (too few mapped genes)")
    next
  }

  gene_list_entrez <- gene_list[gene_df$SYMBOL]
  names(gene_list_entrez) <- gene_df$ENTREZID
  gene_list_entrez <- sort(gene_list_entrez, decreasing = TRUE)

  ## ---- GSEA KEGG
  gsea_kegg <- tryCatch(
    gseKEGG(
      geneList     = gene_list_entrez,
      organism     = "hsa",
      pvalueCutoff = 0.05
    ),
    error = function(e) NULL
  )

  if (is.null(gsea_kegg) || nrow(gsea_kegg@result) == 0) {
    warning("No significant pathways for ", col)
    next
  }

  ## ---- save table
  table_path <- file.path(
    base_results_dir,
    paste0("gsea_kegg_embedding_", embedding_num, ".csv")
  )

  write.csv(gsea_kegg@result, table_path, row.names = FALSE)

  ## ---- save plot
  plot_path <- file.path(
    base_results_dir,
    paste0("gsea_kegg_embedding_", embedding_num, ".png")
  )

  p <- dotplot(
    gsea_kegg,
    showCategory = 20,
    title = paste0("GSEA KEGG pathways – Embedding ", embedding_num)
  )

  ggsave(
    filename = plot_path,
    plot     = p,
    width    = 8,
    height   = 6,
    dpi      = 300
  )
}
```


